# DEVELOPMENT.md - Для разработчиков

Руководство по разработке RQ_MobCounter.

## Структура проекта

```
RQ_MobCounter/
├── main.go              # Точка входа, обработка флагов и логика
├── config.json          # Конфиг по умолчанию (пользовательский)
├── go.mod               # Определение модуля Go
├── go.sum               # Контрольные суммы зависимостей
├── build.bat            # Скрипт сборки для Windows
├── test.ps1             # Скрипт тестирования с цветным выводом
├── config/
│   ├── config.go        # Загрузка/сохранение JSON конфига
│   └── config_test.go   # Тесты для конфига
├── parser/
│   ├── parser.go        # Парсинг HTML логов с регулярными выражениями
│   └── parser_test.go   # Тесты для парсера
├── stats/
│   ├── stats.go         # Подсчет статистики и форматирование
│   └── stats_test.go    # Тесты для статистики
├── build/
│   ├── RQ_MobCounter.exe  # Скомпилированное приложение
│   ├── rqmc.bat           # Алиас для быстрого запуска
│   └── config.json        # Конфигурация приложения
├── test_logs/           # Примеры HTML логов для тестирования
└── README.md            # Документация для пользователей
```

## Пакеты

### config/

Управление конфигурацией приложения.

- `Load()` - загружает конфиг из JSON файла рядом с приложением или использует значения по умолчанию
- `Save()` - сохраняет конфиг в JSON файл рядом с приложением
- `DefaultLogPath` - путь по умолчанию к логам Royal Quest
- `DefaultFilePrefix` - префикс файлов по умолчанию ("exp")

### parser/

Парсинг HTML файлов логов.

- `LogEntry` - структура записи лога (время, имя монстра, опыт)
- `ParseFile(filepath string)` - парсит HTML файл и возвращает список записей
- `parseLogEntry()` - вспомогательная функция для парсинга отдельной записи

### stats/

Вычисление и форматирование статистики.

- `MonsterStats` - структура статистики по монстру
- `Calculator` - вычисляет статистику из записей логов
- `FormatTable()` - форматирует вывод в виде таблицы
- `truncateString()` - обрезает длинные имена монстров

## Запуск тестов

### Все тесты (с цветным выводом)

```bash
# Рекомендуемый способ - с цветным выводом
powershell test.ps1

# Или через build.bat (включает цветной вывод тестов)
build.bat
```

### Тесты конкретного пакета

```bash
go test ./config -v
go test ./parser -v
go test ./stats -v
```

### Тесты с покрытием

```bash
go test ./... -cover
go test ./... -coverprofile=coverage.out
go tool cover -html=coverage.out
```

### Отдельный тест

```bash
go test -run TestParseFile ./parser -v
```

### Стандартный вывод Go (без цветов)

```bash
go test ./... -v
```

## Сборка

### Windows

```bash
build.bat
```

Или вручную:
```bash
go mod tidy
go test ./...
go build -o build/RQ_MobCounter.exe
```

## Кросс-компиляция

```bash
# Windows
GOOS=windows GOARCH=amd64 go build -o build/RQ_MobCounter.exe

# Linux
GOOS=linux GOARCH=amd64 go build -o build/RQ_MobCounter

# macOS
GOOS=darwin GOARCH=amd64 go build -o build/RQ_MobCounter-darwin
```

## Формат HTML логов

Приложение парсит логи в формате:

```html
<TR style='color:#4A92D3' valign=top title='1/16 06:45:41'><TD colspan=2>Злая шкатулка погибает. Получено опыта: 2873.
<TR style='color:#4A92D3' valign=top title='1/16 06:51:17'><TD colspan=2>Росинка погибает.
```

Ключевые особенности:
- Нет закрывающих `</TR>` и `</TD>` тегов
- `title='...'` содержит временную метку события
- Содержимое `<TD>`: имя монстра + "погибает" + опционально опыт
- Опыт в формате: "Получено опыта: XXXX" или "Получено опыт: XXXX"
- Записи без опыта - просто "Монстр погибает."

## Регулярные выражения

### Парсинг строк лога

```go
trRegex := regexp.MustCompile(`<TR[^>]*title='([^']+)'[^>]*><TD[^>]*>([^\n]+)`)
```

Ищет: `title='время'` и содержимое до конца строки

### Парсинг опыта

```go
expRegex := regexp.MustCompile(`Получено опыт[а]?:\s*(\d+)`)
```

Ищет: "Получено опыта:" или "Получено опыт:" с числом

## Логирование

Приложение использует стандартный пакет `log` для ошибок и вывод в `fmt.Printf` для информационных сообщений.

## Соглашения по коду

- Функции с заглавной буквы - экспортируемые (public)
- Функции со строчной буквы - приватные (private)
- Имена переменных на английском
- Текст сообщений пользователю на русском
- Каждый пакет имеет тесты в файле `*_test.go`

## Добавление новых функций

1. Создайте функцию в соответствующем пакете
2. Напишите тесты в файле `*_test.go`
3. Запустите `go test ./...`
4. Убедитесь, что все тесты проходят
5. Пересоберите приложение

## Отладка

### Вывод отладочной информации

```go
fmt.Printf("DEBUG: %v\n", value)
```

### Запуск с профилем

```bash
go run -race main.go
```

## Зависимости

Проект использует только стандартную библиотеку Go:
- `encoding/json` - парсинг конфига
- `flag` - обработка флагов командной строки
- `fmt`, `log`, `os` - стандартные операции
- `regexp` - парсинг HTML логов
- `strings`, `path/filepath` - работа со строками и путями
- `sort` - сортировка статистики
- `time` - работа со временем

Никаких внешних зависимостей!

## Тестирование

Проект содержит полный набор тестов:

- **config_test.go** - 5 тестов (загрузка, сохранение, нормализация путей)
- **parser_test.go** - 19 тестов (парсинг записей, файлов, имён, опыта)
- **stats_test.go** - 8 тестов (вычисление, форматирование, сортировка)

**Всего 32 теста** покрывают основной функционал приложения.

Запуск всех тестов:
```bash
go test ./... -v
```

## Производство

Для релиза:

1. Убедитесь, что все тесты проходят: `go test ./...`
2. Обновите версию в комментариях (если применимо)
3. Запустите сборку: `build.bat` или `build.sh`
4. Протестируйте выполняемый файл на реальных логах
5. Упакуйте содержимое папки `build/` в архив для распространения

---

**Вопросы?** Изучите исходный код или запустите тесты для лучшего понимания логики.
